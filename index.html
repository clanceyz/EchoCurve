<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoCurve - SRS Practice</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --text: #e0e0e0;
            --accent: #00ADB5;
            --card-bg: #2d2d2d;
            --input-bg: #333;
            --danger: #ff6b6b;
            --success: #4cd137;
            --warning: #fbc531;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        h1 {
            text-align: center;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        /* Layout */
        .app-container {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .sidebar {
            width: 220px;
            background: #222;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex-shrink: 0;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        /* Sidebar Elements */
        .menu-btn {
            background: #333;
            border: 1px solid #444;
            padding: 15px;
            font-size: 1.1em;
            color: var(--text);
            cursor: pointer;
            text-align: left;
            border-radius: 8px;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-btn:hover {
            background: #444;
            border-color: var(--accent);
        }

        .menu-btn.primary {
            background: var(--accent);
            border: none;
            color: white;
            justify-content: center;
            text-align: center;
            font-weight: bold;
        }

        .badge {
            background: var(--accent);
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .status-text {
            font-size: 0.9em;
            color: #888;
            text-align: center;
            margin-bottom: 5px;
        }

        /* Inputs */
        .controls {
            display: flex;
            gap: 10px;
            background: var(--card-bg);
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 0;
        }

        input[type="text"],
        textarea {
            flex-grow: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background: var(--input-bg);
            color: white;
            font-size: 16px;
            outline: none;
            font-family: inherit;
        }

        textarea {
            resize: none;
            overflow-y: hidden;
            min-height: 1.4em;
            line-height: 1.4;
            height: auto;
        }

        input[type="text"]:focus,
        textarea:focus {
            background: #444;
            box-shadow: 0 0 0 2px var(--accent);
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
            color: white;
        }

        button:hover {
            opacity: 0.9;
        }

        .btn-add {
            background-color: var(--accent);
        }

        .btn-play {
            background-color: transparent;
            color: var(--success);
            font-size: 1.2em;
            padding: 5px;
        }

        .btn-del {
            background-color: transparent;
            color: var(--danger);
            font-size: 1.2em;
            padding: 5px;
        }

        /* Dictionary */
        .dict-results {
            background: #222;
            padding: 20px;
            border-left: 4px solid var(--accent);
            animation: fadeIn 0.3s;
            margin-top: 10px;
            border-radius: 5px;
        }

        .dict-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }

        .dict-word {
            font-size: 1.8em;
            color: var(--accent);
            font-weight: bold;
        }

        .dict-phonetic {
            font-family: 'Lucida Sans Unicode', 'Arial Unicode MS', sans-serif;
            color: #888;
        }

        .btn-audio {
            background: none;
            border: 1px solid #444;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            color: var(--success);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-audio:hover {
            background: #333;
        }

        .meaning-block {
            margin-bottom: 15px;
        }

        .pos-tag {
            background: #444;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 8px;
            text-transform: uppercase;
        }

        .def-list {
            margin: 5px 0 0 20px;
            padding: 0;
            color: #ccc;
            font-size: 0.95em;
        }

        .def-list li {
            margin-bottom: 4px;
        }

        .section-header {
            font-weight: bold;
            color: var(--accent);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .example-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #1a1a1a;
            margin-bottom: 8px;
            border-radius: 5px;
            border: 1px solid #333;
        }

        .example-text {
            margin-right: 10px;
            cursor: pointer;
        }

        .btn-small-add {
            background: var(--success);
            font-size: 0.8em;
            padding: 5px 10px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modals & Cards */
        .card {
            background: var(--card-bg);
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .text-content {
            flex-grow: 1;
            margin: 0 15px;
            font-size: 18px;
            cursor: pointer;
        }

        .meta-info {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 20px;
            background: #252525;
            border-radius: 8px;
        }

        #review-modal,
        #library-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-card {
            width: 500px;
            padding: 40px;
            text-align: center;
            border: 2px solid var(--accent);
            background: #222;
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .masked {
            background-color: #555;
            color: transparent;
            border-radius: 4px;
        }

        .btn-forgot {
            background-color: var(--danger);
            padding: 15px;
            font-size: 1.2em;
            width: 100%;
        }

        .btn-remember {
            background-color: var(--success);
            padding: 15px;
            font-size: 1.2em;
            width: 100%;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .app-container {
                flex-direction: column;
                gap: 15px;
            }

            .sidebar {
                width: 100%;
                padding: 15px;
                box-sizing: border-box;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 10px;
                border-bottom: 2px solid var(--accent);
            }

            .sidebar>div:first-child {
                width: 100%;
                margin-bottom: 5px !important;
            }

            .menu-btn {
                flex: 1;
                padding: 10px;
                font-size: 0.9em;
                min-width: 140px;
            }

            .menu-btn.primary {
                width: 100%;
                order: 3;
            }

            hr {
                display: none;
            }

            .main-content {
                width: 100%;
            }

            .controls {
                padding: 15px;
                flex-wrap: wrap;
            }

            .controls input[type="text"] {
                width: 100%;
                margin-bottom: 5px;
            }

            .controls button {
                width: 100%;
            }

            .modal-card {
                width: 95% !important;
                padding: 20px !important;
            }

            #modal-text {
                font-size: 1.5em !important;
            }

            .btn-forgot,
            .btn-remember {
                padding: 12px;
                font-size: 1em;
            }

            .card {
                padding: 15px;
            }

            .text-content {
                font-size: 16px;
                margin: 0 10px;
            }

            .card-top {
                align-items: flex-start;
            }

            .meta-info {
                margin-left: 35px !important;
            }
        }
    </style>
</head>

<body>

    <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="handleImportFile(event)">

    <div class="app-container">

        <div class="sidebar">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                <div style="text-align: left;">
                    <h1 style="font-size: 1.5em; margin: 0; color: var(--accent);">EchoCurve</h1>
                    <div id="username-display" style="font-size: 0.85em; color: #888; margin-top: 4px;"></div>
                </div>
                <div id="settings-menu" style="position: relative;">
                    <button onclick="toggleSettingsDropdown()"
                        style="background: #333; border: 1px solid #444; border-radius: 6px; padding: 6px 8px; font-size: 1em; cursor: pointer; color: #888;">
                        ‚öôÔ∏è
                    </button>
                    <div id="settings-dropdown"
                        style="display: none; position: absolute; top: 35px; right: 0; background: #2d2d2d; border: 1px solid #444; border-radius: 8px; min-width: 160px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); z-index: 100;">
                        <button onclick="exportData()"
                            style="width: 100%; padding: 12px 16px; background: none; border: none; color: #e0e0e0; text-align: left; cursor: pointer; font-size: 1em;"
                            onmouseover="this.style.background='#3a3a3a'" onmouseout="this.style.background='none'">
                            üì§ Export Data
                        </button>
                        <button onclick="importData()"
                            style="width: 100%; padding: 12px 16px; background: none; border: none; color: #e0e0e0; text-align: left; cursor: pointer; font-size: 1em;"
                            onmouseover="this.style.background='#3a3a3a'" onmouseout="this.style.background='none'">
                            üì• Import Data
                        </button>
                        <div style="border-top: 1px solid #444; margin: 4px 0;"></div>
                        <button onclick="logout()"
                            style="width: 100%; padding: 12px 16px; background: none; border: none; color: #ff6b6b; text-align: left; cursor: pointer; font-size: 1em;"
                            onmouseover="this.style.background='#3a3a3a'" onmouseout="this.style.background='none'">
                            üö™ Logout
                        </button>
                    </div>
                </div>
            </div>

            <button class="menu-btn" onclick="openLibraryModal()">
                <span>üìö Library</span>
                <span id="total-count" class="badge">0</span>
            </button>

            <hr style="width: 100%; border: 0; border-top: 1px solid #444; margin: 0;">

            <button id="btn-start-review" class="menu-btn primary" style="display: none;"
                onclick="startReviewSession()">
                üöÄ Start Review
            </button>
        </div>

        <!-- Main Content (Inputs) -->
        <div class="main-content">
            <!-- 1. Sentence Input -->
            <div class="controls" style="border-radius: 10px 10px 0 0; margin-bottom: 10px;">
                <span style="font-size: 1.2em; margin-right: 10px;">‚úçÔ∏è</span>
                <textarea id="newSentence" tabindex="2" rows="1" spellcheck="true"
                    placeholder="Type a new sentence (or paste one) to learn..." onkeypress="handleEnter(event)"
                    oninput="autoResize(this)"></textarea>
                <button class="btn-add" tabindex="-1" onclick="addSentence()">Add</button>
            </div>

            <!-- 2. Word Lookup -->
            <div class="controls" style="border-radius: 0 0 10px 10px;">
                <span style="font-size: 1.2em; margin-right: 10px;">üîç</span>
                <textarea id="wordInput" tabindex="1" rows="1" spellcheck="true"
                    placeholder="Type a word to find examples (Enter to search)..." onkeypress="handleWordEnter(event)"
                    oninput="autoResize(this)"></textarea>
                <button class="btn-add" tabindex="-1" onclick="lookupWord()">Search</button>
            </div>

            <!-- 3. Dictionary Results -->
            <div id="dict-results" class="dict-results" style="display: none;"></div>
        </div>

    </div>

    <!-- Library Modal Overlay -->
    <div id="library-modal" onmousedown="modalMouseDownTarget = event.target"
        onmouseup="if(event.target === this && modalMouseDownTarget === this) this.style.display='none'"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 900; align-items: center; justify-content: center;">
        <div class="modal-card"
            style="width: 800px; height: 80vh; display: flex; flex-direction: column; padding: 20px; text-align: left;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px;">
                <h2 style="margin: 0; color: var(--accent);">üìö Library</h2>
                <button onclick="document.getElementById('library-modal').style.display='none'"
                    style="background:none; border:none; font-size: 1.5em; color: #666;">‚úï</button>
            </div>

            <div id="library-list" style="overflow-y: auto; flex-grow: 1; padding-right: 10px;"></div>
        </div>
    </div>

    <!-- Review Modal Overlay -->
    <div id="review-modal" onmousedown="modalMouseDownTarget = event.target"
        onmouseup="if(event.target === this && modalMouseDownTarget === this) closeReviewModal()">
        <div class="modal-card" style="position: relative;">
            <button onclick="closeReviewModal()"
                style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 1.5em; color: #666; padding: 5px;">‚úï</button>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="color: #888; font-weight: bold; text-transform: uppercase; letter-spacing: 2px;">
                    Review Time</div>
                <div id="review-progress" style="color: var(--accent); font-size: 0.9em;"></div>
            </div>

            <div id="modal-text" style="font-size: 2em; margin-bottom: 20px; cursor: pointer;"
                onclick="toggleModalReveal()">
                <span id="modal-text-content" class="masked">Loading...</span>
            </div>

            <div style="margin-bottom: 20px;">
                <button class="btn-play"
                    style="font-size: 1.2em; padding: 10px 25px; border: 1px solid #444; border-radius: 30px; background: #333;"
                    onclick="replayCurrentReview()">
                    üîä Replay Audio
                </button>
                <button class="btn-play"
                    style="font-size: 1.2em; padding: 10px 25px; border: 1px solid #444; border-radius: 30px; background: #333; margin-left: 10px;"
                    onclick="editCurrentReview()">
                    ‚úèÔ∏è Edit
                </button>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <button class="btn-forgot" onclick="finishReview(false)">Again ‚ùå</button>
                <button class="btn-remember" onclick="finishReview(true)">Good ‚úÖ</button>
            </div>
        </div>
    </div>

    <!-- Custom Dialog Modal -->
    <div id="dialog-modal" onmousedown="modalMouseDownTarget = event.target"
        onmouseup="if(event.target === this && modalMouseDownTarget === this) closeDialog(false)"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; align-items: center; justify-content: center;">
        <div class="modal-card" style="width: 400px; padding: 25px; text-align: center;">
            <p id="dialog-message" style="margin-bottom: 20px; font-size: 1.1em;"></p>
            <div id="dialog-input-container" style="margin-bottom: 20px; display: none;">
                <input type="text" id="dialog-input" style="width: 100%; box-sizing: border-box; text-align: center;">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button class="menu-btn" style="text-align: center; padding: 12px;"
                    onclick="closeDialog(false)">Cancel</button>
                <button class="btn-add" onclick="closeDialog(true)">OK</button>
            </div>
        </div>
    </div>

    <!-- Auth Overlay -->
    <div id="auth-overlay"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column;">
        <h1 style="color: var(--accent); margin-bottom: 20px;">EchoCurve</h1>
        <div class="modal-card" style="width: 350px; padding: 30px; text-align: center; border: 1px solid #444;">
            <div id="auth-view-home">
                <p>Welcome. Please enter your username.</p>
                <div id="auth-error"
                    style="display: none; color: #ff6b6b; background: rgba(255,100,100,0.1); padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 0.9em;">
                </div>
                <input type="text" id="auth-username" placeholder="Username" list="user-list" autocomplete="on"
                    style="width: 100%; margin-bottom: 20px; box-sizing: border-box; text-align: center;">
                <datalist id="user-list"></datalist>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="btn-add" onclick="authLogin()">Login</button>
                    <button class="menu-btn" style="text-align: center; padding: 10px;"
                        onclick="authRegister()">Register</button>
                </div>
            </div>
            <div id="auth-view-loading" style="display: none;">
                <p id="auth-status">Processing...</p>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div id="status-bar"
        style="position: fixed; bottom: 10px; right: 10px; background: #333; padding: 5px 10px; font-size: 0.8em; color: #888; border-radius: 5px; opacity: 0.7;">
        Initializing...
    </div>

    <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
    <script>
        const { startRegistration, startAuthentication } = SimpleWebAuthnBrowser;
        let sentences = [];
        let currentUser = localStorage.getItem('echocurve_user');
        let currentToken = localStorage.getItem('echocurve_token');
        const API_URL = '/api/data';
        const synth = window.speechSynthesis;
        let currentReviewItem = null;
        let modalMouseDownTarget = null; // Track mouse events for modal close behavior


        function logStatus(msg) {
            const el = document.getElementById('status-bar');
            if (el) { el.textContent = msg; el.style.opacity = 1; setTimeout(() => el.style.opacity = 0.5, 3000); }
        }

        function showAuthStatus(msg) {
            document.getElementById('auth-view-home').style.display = 'none';
            document.getElementById('auth-view-loading').style.display = 'block';
            document.getElementById('auth-status').textContent = msg;
        }

        function hideAuthStatus() {
            document.getElementById('auth-view-home').style.display = 'block';
            document.getElementById('auth-view-loading').style.display = 'none';
        }

        function showAuthError(msg) {
            const errEl = document.getElementById('auth-error');
            if (errEl) {
                errEl.textContent = msg;
                errEl.style.display = 'block';
            }
        }

        function clearAuthError() {
            const errEl = document.getElementById('auth-error');
            if (errEl) {
                errEl.style.display = 'none';
                errEl.textContent = '';
            }
        }

        // Custom dialog system (replaces browser confirm/prompt)
        let dialogResolve = null;

        function showDialog(message, defaultValue = null) {
            return new Promise((resolve) => {
                dialogResolve = resolve;
                document.getElementById('dialog-message').textContent = message;
                const inputContainer = document.getElementById('dialog-input-container');
                const input = document.getElementById('dialog-input');

                if (defaultValue !== null) {
                    inputContainer.style.display = 'block';
                    input.value = defaultValue;
                    setTimeout(() => input.focus(), 50);
                } else {
                    inputContainer.style.display = 'none';
                }

                document.getElementById('dialog-modal').style.display = 'flex';
            });
        }

        function closeDialog(confirmed) {
            const modal = document.getElementById('dialog-modal');
            modal.style.display = 'none';

            if (dialogResolve) {
                const inputContainer = document.getElementById('dialog-input-container');
                if (inputContainer.style.display === 'block') {
                    // Prompt mode - return input value or null
                    dialogResolve(confirmed ? document.getElementById('dialog-input').value : null);
                } else {
                    // Confirm mode - return boolean
                    dialogResolve(confirmed);
                }
                dialogResolve = null;
            }
        }

        // Handle Enter key in dialog input
        document.getElementById('dialog-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                closeDialog(true);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                closeDialog(false);
            }
        });

        async function authRegister() {
            clearAuthError();
            const username = document.getElementById('auth-username').value.trim().toLowerCase();
            if (!username) return showAuthError('Username required');

            showAuthStatus('Checking registration options...');
            try {
                const optionsRes = await fetch(`/api/auth/register-options?username=${username}`);
                if (!optionsRes.ok) throw new Error('Registration not allowed');
                const options = await optionsRes.json();

                showAuthStatus('Waiting for authenticator...');
                const attestation = await startRegistration(options);

                showAuthStatus('Verifying registration...');
                const verifyRes = await fetch('/api/auth/verify-registration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, registrationResponse: attestation })
                });

                const result = await verifyRes.json();
                if (result.verified && result.token) {
                    currentUser = username;
                    currentToken = result.token;
                    localStorage.setItem('echocurve_user', username);
                    localStorage.setItem('echocurve_token', result.token);
                    saveKnownUsername(username);
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('username-display').textContent = 'üë§ ' + username;
                    loadData();
                } else {
                    throw new Error(result.error || 'Verification failed');
                }
            } catch (err) {
                showAuthError(`Register error: ${err.message}`);
                hideAuthStatus();
            }
        }

        async function authLogin() {
            clearAuthError();
            const username = document.getElementById('auth-username').value.trim().toLowerCase();
            if (!username) return showAuthError('Username required');

            showAuthStatus('Checking login options...');
            try {
                const optionsRes = await fetch(`/api/auth/login-options?username=${username}`);
                if (!optionsRes.ok) {
                    const errData = await optionsRes.json().catch(() => ({}));
                    throw new Error(errData.error || 'User not found');
                }
                const options = await optionsRes.json();

                showAuthStatus('Waiting for authenticator...');
                const assertion = await startAuthentication(options);

                showAuthStatus('Verifying login...');
                const verifyRes = await fetch('/api/auth/verify-authentication', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, authenticationResponse: assertion })
                });

                const result = await verifyRes.json();
                if (result.verified && result.token) {
                    currentUser = username;
                    currentToken = result.token;
                    localStorage.setItem('echocurve_user', username);
                    localStorage.setItem('echocurve_token', result.token);
                    saveKnownUsername(username);
                    document.getElementById('auth-overlay').style.display = 'none';
                    document.getElementById('username-display').textContent = 'üë§ ' + username;
                    loadData();
                } else {
                    throw new Error(result.error || 'Verification failed');
                }
            } catch (err) {
                showAuthError(`Login error: ${err.message}`);
                hideAuthStatus();
            }
        }

        if (currentUser && currentToken) {
            document.getElementById('auth-overlay').style.display = 'none';
            document.getElementById('auth-username').value = currentUser;
            document.getElementById('username-display').textContent = 'üë§ ' + currentUser;
        } else {
            // Clear any partial state
            currentUser = null;
            currentToken = null;
            localStorage.removeItem('echocurve_user');
            localStorage.removeItem('echocurve_token');
            // Pre-fill with last known username for convenience
            const knownUsers = JSON.parse(localStorage.getItem('echocurve_known_users') || '[]');
            if (knownUsers.length > 0) {
                document.getElementById('auth-username').value = knownUsers[knownUsers.length - 1];
            }
        }

        async function loadData() {
            if (!currentUser || !currentToken) return;
            logStatus('Connecting to server...');
            try {
                const res = await fetch(`${API_URL}?t=${Date.now()}`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                if (res.status === 401) {
                    // Token invalid or expired - require re-login
                    currentUser = null;
                    currentToken = null;
                    localStorage.removeItem('echocurve_user');
                    localStorage.removeItem('echocurve_token');
                    document.getElementById('auth-overlay').style.display = 'flex';
                    logStatus('Session expired. Please log in again.');
                    return;
                }
                if (!res.ok) throw new Error(`Server returned ${res.status}`);

                sentences = await res.json();
                logStatus(`Server has ${sentences.length} items.`);
                render();
            } catch (err) {
                console.error('Failed to load:', err);
                logStatus('Error loading data.');
                sentences = [];
                render();
            }
        }

        async function save() {
            if (!currentUser || !currentToken) return false;
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify(sentences)
                });
                if (res.status === 401) {
                    // Token expired during session
                    currentUser = null;
                    currentToken = null;
                    localStorage.removeItem('echocurve_user');
                    localStorage.removeItem('echocurve_token');
                    document.getElementById('auth-overlay').style.display = 'flex';
                    logStatus('Session expired. Please log in again.');
                    return false;
                }
                if (!res.ok) throw new Error('Server unavailable');
                render();
                return true;
            } catch (err) {
                console.error('Failed to save:', err);
                logStatus('‚ùå ERROR: Could not save!');
                return false;
            }
        }

        function updateDashboard() {
            const now = Date.now();
            const dueCount = sentences.filter(s => s.nextReview <= now).length;
            const btn = document.getElementById('btn-start-review');
            if (btn) btn.style.display = 'flex';

            if (dueCount > 0) {
                if (btn) {
                    btn.textContent = `üöÄ Start Review (${dueCount})`;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.background = 'var(--accent)';
                    btn.style.cursor = 'pointer';
                }
            } else {
                if (btn) {
                    btn.textContent = `‚úÖ No Reviews`;
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.background = '#444';
                    btn.style.cursor = 'default';
                }
            }
            const totalCountEl = document.getElementById('total-count');
            if (totalCountEl) totalCountEl.textContent = sentences.length;
        }

        let reviewSessionTotal = 0;
        let reviewSessionCompleted = 0;

        function startReviewSession() {
            const now = Date.now();
            const dueItems = sentences.filter(s => s.nextReview <= now);
            reviewSessionTotal = dueItems.length;
            reviewSessionCompleted = 0;

            if (dueItems.length > 0) {
                startReview(dueItems[0]);
            } else {
                updateDashboard();
            }
        }

        function startReview(item) {
            currentReviewItem = item;
            const modal = document.getElementById('review-modal');
            modal.style.display = 'flex';
            const textEl = document.getElementById('modal-text-content');
            textEl.textContent = item.text;
            textEl.className = 'masked';

            // Update progress display
            const progressEl = document.getElementById('review-progress');
            if (progressEl && reviewSessionTotal > 0) {
                progressEl.textContent = `${reviewSessionCompleted + 1} of ${reviewSessionTotal}`;
            }

            speak(item.text);
        }

        function finishReview(success) {
            if (!currentReviewItem) return;
            const item = currentReviewItem;

            if (success) {
                const intervals = [0.02, 0.5, 1, 2, 3, 5, 8, 14, 21, 30, 45, 60, 90]; // 0.02 = ~30 min
                item.stage = Math.min(item.stage + 1, intervals.length);
                item.interval = intervals[item.stage - 1] || (item.interval * 2);
            } else {
                item.stage = 1;
                item.interval = 0.5;
            }
            item.nextReview = Date.now() + (item.interval * 24 * 60 * 60 * 1000);

            save();
            reviewSessionCompleted++;

            const now = Date.now();
            const nextItem = sentences.find(s => s.nextReview <= now && s.id !== item.id);
            if (nextItem) {
                setTimeout(() => startReview(nextItem), 300);
            } else {
                document.getElementById('review-modal').style.display = 'none';
                currentReviewItem = null;
                updateDashboard();
            }
        }

        function openLibraryModal() { document.getElementById('library-modal').style.display = 'flex'; }
        function toggleModalReveal() { document.getElementById('modal-text-content').classList.toggle('masked'); }
        function replayCurrentReview() { if (currentReviewItem) speak(currentReviewItem.text); }
        function closeReviewModal() { document.getElementById('review-modal').style.display = 'none'; currentReviewItem = null; updateDashboard(); }

        async function editCurrentReview() {
            if (!currentReviewItem) return;
            const newText = await showDialog('Edit sentence:', currentReviewItem.text);
            if (newText && newText !== currentReviewItem.text) {
                currentReviewItem.text = newText;
                document.getElementById('modal-text-content').textContent = newText;
                save();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // ESC closes any open modal
            if (e.key === 'Escape') {
                // Close dialog first if open
                if (document.getElementById('dialog-modal').style.display === 'flex') {
                    closeDialog(false);
                    return;
                }
                document.getElementById('review-modal').style.display = 'none';
                document.getElementById('library-modal').style.display = 'none';
                currentReviewItem = null;
                updateDashboard();
                return;
            }

            // Skip shortcuts when typing in input fields
            const activeEl = document.activeElement;
            if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
                return;
            }

            // Review modal shortcuts
            const reviewModal = document.getElementById('review-modal');
            if (reviewModal.style.display !== 'flex') return;

            // Prevent space from triggering focused buttons
            if (e.key === ' ' || e.code === 'Space') {
                e.preventDefault();
                replayCurrentReview(); // Space = Replay
                return;
            }

            if (e.key.toLowerCase() === 'a') {
                e.preventDefault();
                finishReview(false); // Again
            } else if (e.key.toLowerCase() === 's') {
                e.preventDefault();
                replayCurrentReview(); // Replay
            } else if (e.key.toLowerCase() === 'd') {
                e.preventDefault();
                finishReview(true); // Good
            } else if (e.key.toLowerCase() === 'e') {
                e.preventDefault();
                editCurrentReview(); // Edit
            }
        });

        function render() {
            updateDashboard();
            const libList = document.getElementById('library-list');
            if (!libList) return;
            libList.innerHTML = '';
            const sortedLibrary = [...sentences].sort((a, b) => b.id - a.id);
            if (sortedLibrary.length === 0) {
                libList.innerHTML = '<div class="empty-state">Library is empty. Add a sentence above!</div>';
            } else {
                sortedLibrary.forEach(s => {
                    const nextDate = new Date(s.nextReview).toLocaleDateString();
                    const isDue = s.nextReview <= Date.now();
                    const statusColor = isDue ? 'var(--accent)' : '#666';
                    const div = document.createElement('div');
                    div.className = 'card';

                    // Build DOM safely to prevent XSS
                    const cardTop = document.createElement('div');
                    cardTop.className = 'card-top';

                    const playBtn = document.createElement('button');
                    playBtn.className = 'btn-play';
                    playBtn.tabIndex = -1;
                    playBtn.textContent = '‚ñ∂Ô∏è';
                    playBtn.onclick = () => speak(s.text);

                    const textSpan = document.createElement('span');
                    textSpan.className = 'text-content';
                    textSpan.textContent = s.text; // Safe: textContent escapes HTML
                    textSpan.onclick = () => editSentence(s.id);

                    const btnGroup = document.createElement('div');

                    const editBtn = document.createElement('button');
                    editBtn.className = 'btn-del';
                    editBtn.style.cssText = 'color:var(--warning); margin-right:5px;';
                    editBtn.tabIndex = -1;
                    editBtn.textContent = '‚úèÔ∏è';
                    editBtn.onclick = () => editSentence(s.id);

                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn-del';
                    delBtn.tabIndex = -1;
                    delBtn.textContent = 'üóëÔ∏è';
                    delBtn.onclick = () => deleteSentence(s.id);

                    btnGroup.appendChild(editBtn);
                    btnGroup.appendChild(delBtn);
                    cardTop.appendChild(playBtn);
                    cardTop.appendChild(textSpan);
                    cardTop.appendChild(btnGroup);

                    const metaDiv = document.createElement('div');
                    metaDiv.className = 'meta-info';
                    metaDiv.style.cssText = `color:${statusColor}; margin-left: 45px;`;
                    metaDiv.innerHTML = isDue ? '<b>DUE NOW</b>' : 'Next: ' + nextDate;
                    metaDiv.innerHTML += ` (Interval: ${s.interval}d)`;

                    div.appendChild(cardTop);
                    div.appendChild(metaDiv);
                    libList.appendChild(div);
                });
            }
        }

        async function addSentence() {
            const input = document.getElementById('newSentence');
            const text = input.value.trim();
            if (text) {
                sentences.unshift({
                    id: Date.now(),
                    text: text,
                    nextReview: Date.now() + (0.5 * 24 * 60 * 60 * 1000),
                    interval: 0.5,
                    stage: 0
                });

                const success = await save();
                if (success) {
                    input.value = '';
                    input.style.height = 'auto';
                    speak(text);
                } else {
                    sentences.shift();
                }
                render();
            }
        }

        function handleEnter(e) { if (e.key === 'Enter') { e.preventDefault(); addSentence(); } }

        async function deleteSentence(id) {
            const confirmed = await showDialog('Delete this sentence?');
            if (confirmed) {
                sentences = sentences.filter(s => s.id !== id);
                save();
            }
        }

        async function editSentence(id) {
            const item = sentences.find(s => s.id === id);
            if (!item) return;
            const newText = await showDialog('Edit sentence:', item.text);
            if (newText && newText !== item.text) {
                item.text = newText;
                save();
            }
        }

        // Audio player for Google Cloud TTS
        let currentAudio = null;

        async function speak(text) {
            // Stop any currently playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            synth.cancel();

            try {
                // Try Google Cloud TTS first
                const res = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.audioContent) {
                        // Play the audio from base64
                        currentAudio = new Audio(`data:audio/mp3;base64,${data.audioContent}`);
                        currentAudio.play();
                        return;
                    }
                }
            } catch (err) {
                console.log('Google TTS unavailable, using browser TTS:', err.message);
            }

            // Fallback to browser TTS
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.95;
            utterance.pitch = 1.0;

            const voices = synth.getVoices();
            const preferredVoices = ['Google US English', 'Microsoft Zira', 'Microsoft David', 'Samantha', 'Alex', 'Daniel'];
            let selectedVoice = voices.find(v => preferredVoices.some(p => v.name.includes(p)));
            if (!selectedVoice) {
                selectedVoice = voices.find(v => v.lang.startsWith('en') && (v.name.includes('Natural') || v.name.includes('Neural')));
            }
            if (!selectedVoice) {
                selectedVoice = voices.find(v => v.lang.startsWith('en'));
            }
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            synth.speak(utterance);
        }

        // Pre-load voices (some browsers need this)
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = () => synth.getVoices();
        }

        function handleWordEnter(e) { if (e.key === 'Enter') { e.preventDefault(); lookupWord(); } }

        // Detect if text contains Chinese characters
        function containsChinese(text) {
            return /[\u4e00-\u9fff]/.test(text);
        }

        // Translate Chinese to English using MyMemory API
        async function translateToEnglish(text) {
            const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=zh|en`);
            if (!res.ok) throw new Error('Translation failed');
            const data = await res.json();
            if (data.responseStatus !== 200) throw new Error('Translation failed');
            return data.responseData.translatedText;
        }

        async function lookupWord() {
            const input = document.getElementById('wordInput');
            const word = input.value.trim();
            if (!word) return;
            const resEl = document.getElementById('dict-results');
            resEl.style.display = 'block';

            try {
                let lookupTerm = word;
                let translationNote = '';

                // If Chinese, translate first
                if (containsChinese(word)) {
                    resEl.innerHTML = `Translating "${word}"...`;
                    const translated = await translateToEnglish(word);
                    lookupTerm = translated.toLowerCase().trim();
                    translationNote = `<div style="margin-bottom: 15px; padding: 10px; background: #2a2a4a; border-radius: 6px; border-left: 3px solid var(--accent);">
                        <span style="color: #888;">Chinese:</span> <strong>${word}</strong> ‚Üí 
                        <span style="color: #888;">English:</span> <strong style="color: var(--accent);">${lookupTerm}</strong>
                    </div>`;
                }

                resEl.innerHTML = `Searching for "${lookupTerm}"...`;
                const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${lookupTerm}`);
                if (!res.ok) throw new Error('Not found');
                const data = await res.json();
                renderDictionary(data[0], translationNote);
            } catch (err) {
                resEl.innerHTML = `Could not find definition for "${word}".`;
            }
        }

        function renderDictionary(data, translationNote = '') {
            const resEl = document.getElementById('dict-results');
            let html = translationNote + `
                <div class="dict-header">
                    <div class="dict-word">${data.word}</div>
                    <div class="dict-phonetic">${data.phonetic || ''}</div>
                </div>
            `;
            data.meanings.forEach(m => {
                html += `
                    <div class="meaning-block">
                        <span class="pos-tag">${m.partOfSpeech}</span>
                        <ul class="def-list">
                            ${m.definitions.slice(0, 3).map(d => {
                    let defHtml = `<li>${d.definition}`;
                    if (d.example) {
                        const escapedExample = d.example.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        defHtml += `
                                        <div style="margin-top: 8px; padding: 8px 12px; background: #333; border-radius: 6px; display: flex; align-items: center; gap: 10px;">
                                            <span style="flex-grow: 1; color: #aaa; font-style: italic;">"${d.example}"</span>
                                            <button onclick="addDictionarySentence('${escapedExample}', this)" 
                                                style="padding: 4px 12px; font-size: 0.85em; background: var(--accent); border: none; border-radius: 4px; color: white; cursor: pointer; white-space: nowrap;">
                                                + Add
                                            </button>
                                        </div>
                                    `;
                    }
                    defHtml += `</li>`;
                    return defHtml;
                }).join('')}
                        </ul>
                    </div>
                `;
            });
            resEl.innerHTML = html;
        }

        function addDictionarySentence(text, btn) {
            document.getElementById('newSentence').value = text;
            addSentence();
            const originalText = btn.textContent;
            btn.textContent = "‚úÖ Added";
            btn.style.backgroundColor = "#444";
            setTimeout(() => { btn.textContent = originalText; btn.style.backgroundColor = ""; }, 1000);
        }
        // Settings menu toggle
        function toggleSettingsDropdown() {
            const dropdown = document.getElementById('settings-dropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('settings-menu');
            const dropdown = document.getElementById('settings-dropdown');
            if (menu && !menu.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Export data as JSON file
        function exportData() {
            toggleSettingsDropdown();
            const dataStr = JSON.stringify(sentences, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `echocurve-${currentUser}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            logStatus('üì§ Data exported successfully!');
        }

        // Import data from JSON file
        function importData() {
            toggleSettingsDropdown();
            document.getElementById('import-file-input').click();
        }

        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const importedData = JSON.parse(text);

                if (!Array.isArray(importedData)) {
                    throw new Error('Invalid data format');
                }

                const confirmed = await showDialog(`Import ${importedData.length} sentences? This will merge with your existing data.`);
                if (!confirmed) return;

                // Merge imported data with existing (avoid duplicates by text)
                const existingTexts = new Set(sentences.map(s => s.text));
                let addedCount = 0;
                importedData.forEach(item => {
                    if (!existingTexts.has(item.text)) {
                        sentences.push({
                            id: Date.now() + Math.random(),
                            text: item.text,
                            nextReview: item.nextReview || Date.now(),
                            interval: item.interval || 0.5,
                            stage: item.stage || 0
                        });
                        addedCount++;
                    }
                });

                await save();
                logStatus(`üì• Imported ${addedCount} new sentences!`);
            } catch (err) {
                logStatus('‚ùå Import failed: Invalid file format');
                console.error('Import error:', err);
            }

            // Reset file input
            event.target.value = '';
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                toggleSettingsDropdown();
                currentUser = null;
                currentToken = null;
                localStorage.removeItem('echocurve_user');
                localStorage.removeItem('echocurve_token');
                sentences = [];
                document.getElementById('auth-overlay').style.display = 'flex';
                document.getElementById('auth-username').value = '';
                hideAuthStatus();
                updateUserDatalist();
                render();
            }
        }

        function saveKnownUsername(username) {
            let known = JSON.parse(localStorage.getItem('echocurve_known_users') || '[]');
            if (!known.includes(username)) {
                known.push(username);
                localStorage.setItem('echocurve_known_users', JSON.stringify(known));
            }
            updateUserDatalist();
        }

        function updateUserDatalist() {
            const known = JSON.parse(localStorage.getItem('echocurve_known_users') || '[]');
            const list = document.getElementById('user-list');
            if (list) {
                list.innerHTML = known.map(u => `<option value="${u}">`).join('');
            }
        }

        function autoResize(textarea) {
            // Reset to single line first
            textarea.style.height = '';
            // Only expand if content exceeds the natural height
            if (textarea.scrollHeight > textarea.clientHeight) {
                textarea.style.height = textarea.scrollHeight + 'px';
            }
        }

        window.onload = () => {
            updateUserDatalist();
            loadData();

            // Focus management - keep cursor on input boxes
            const sentenceInput = document.getElementById('newSentence');
            const wordInput = document.getElementById('wordInput');
            const inputs = [sentenceInput, wordInput];

            // Initial focus on sentence input after auth
            setTimeout(() => {
                if (document.getElementById('auth-overlay').style.display === 'none') {
                    sentenceInput.focus();
                }
            }, 100);

            // TAB cycles between the two inputs only
            inputs.forEach((input, idx) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        inputs[(idx + 1) % inputs.length].focus();
                    }
                });

                // Prevent focus from leaving inputs (unless modal is open)
                input.addEventListener('blur', () => {
                    setTimeout(() => {
                        const active = document.activeElement;
                        const authVisible = document.getElementById('auth-overlay').style.display !== 'none';
                        const dialogVisible = document.getElementById('dialog-modal').style.display === 'flex';
                        const reviewVisible = document.getElementById('review-modal').style.display === 'flex';
                        const libraryVisible = document.getElementById('library-modal').style.display === 'flex';

                        // Only refocus if no modal is open and focus left the inputs
                        if (!authVisible && !dialogVisible && !reviewVisible && !libraryVisible) {
                            if (!inputs.includes(active)) {
                                input.focus();
                            }
                        }
                    }, 10);
                });
            });
        };
    </script>
</body>

</html>